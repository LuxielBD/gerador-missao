<!DOCTYPE html>
<!--
  PWA – Gerador de Missões Ordo Realitas
  Lógica corrigida e estável
-->
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerador de Missões - OPRPG</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#1f2937" />

  <style>
    body {
      font-family: Spectral, sans-serif;
      background: #000000; /* pitch black */
      color: #e5e7eb;
      margin: 0;
      padding: 20px;
    }

    h1, h2 {
      color: #f9fafb;
    }

    .card {
      background: #0b0b0b; /* preto em tom mais claro */
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, .8);
      border: 1px solid #151515;
    }

    button {
      background: #b91c1c; /* vermelho */
      border: none;
      padding: 12px 18px;
      color: #ffffff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }

    button:hover {
      background: #dc2626; /* vermelho mais vivo */
    }

    .story {
      font-size: 18px;
      line-height: 1.6;
    }

    .highlight {
      color: #dc2626; /* vermelho para textos randomizados */
      font-weight: bold;
    }
  </style>
</head>
<body>

<h1>Gerador de Missões – OPRPG</h1>

<div class="card">
  <button id="btnGerar">Gerar Missão</button>
</div>

<div class="card story" id="historia">
  Clique no botão para gerar uma missão.
</div>

<div class="card" id="detalhes">
  <h2>Detalhes Revelados</h2>
  <div id="detalhesTexto">Nenhum detalhe revelado ainda.</div>
</div>

<script>
/********************
 * FUNÇÕES BÁSICAS
 ********************/
function rolar(lista) {
  return lista[Math.floor(Math.random() * lista.length)];
}

function rolarCombinado(lista, marcador) {
  const limpa = lista.filter(l => l !== marcador);
  const primeiro = rolar(limpa);
  const segundo = rolar(limpa.filter(l => l !== primeiro));
  return `${primeiro} e ${segundo}`;
}

/********************
 * TABELAS DE ROLAGEM
 ********************/
const tabelas = {
  sujeito: [
    'inocente curioso',
    'criminoso',
    'pessoa influente (magnata, político...)',
    'bando cultista',
    'cultista independente',
    'ex-agente da Ordo Realitas',
    'item amaldiçoado',
    'criatura paranormal'
  ],
  acao: [
    'invocou uma criatura de propósito',
    'invocou uma criatura sem querer',
    'está sequestrando inocentes',
    'está assassinando inocentes',
    'está usando um ritual item amaldiçoado para cometer crimes mundanos (roubo, extorsão...)',
    'está recrutando cultistas',
    'está pesquisando um ritual perigoso',
    'está coletando itens amaldiçoados',
    'matou um agente da Ordo Realitas',
    'acao combinada*'
  ],
  local: [
    'escola','hospital','vilarejo','fazenda','mata fechada','becos de metrópole','arranha-céu',
    'grande loja de departamento','esgoto','zona industrial da cidade','shopping center','orfanato',
    'museu','cemitério','delegacia ou base militar','mansão','antiga sede da Ordo Realitas','navio','ilha remota',
    'local combinado*'
  ],
  amigo: [
    'civil alheio ao paranormal',
    'civil exposto ao paranormal',
    'antigo conhecido dos agentes',
    'agente da Ordo Realitas'
  ],
  objeto: [
    'equipamento',
    'ingrediente para um ritual poderoso (máscara ritualística, gema rara...)',
    `equipamento modificado com <strong>${rolar([1,2,3]) - 1}</strong> modificações`,
    'artefato com grande valor para a Ordo Realitas (tomo antigo, relíquia ancestral...)',
    'item amaldiçoado',
    'objeto combinado*'
  ],
  evento: [
    'o aparecimento de uma/outra criatura paranormal de grande poder',
    'a chegada de reforços inimigos',
    'uma doença paranormal/maldição afetando o aliado',
    'civis se revoltando contra eles',
    'a revelação de que o aliado era o vilão',
    'a descoberta de que as ações do inimigo eram justificadas',
    'a perda de seus equipamentos (por furto, falhas tecnológicas...)',
    'ter que proteger um civil',
    'a perda de comunicação com a Ordo Realitas e acesso ao sistema de crédito',
    'agentes da lei os importunando',
    'um desastre em grande escala (incêndio, tempestade, furacão, agitação civil...)',
    'o aparecimento de um antigo inimigo'
  ]
};

/********************
 * GERADOR PRINCIPAL
 ********************/
function gerarHistoria() {
  const r = {
    sujeito: rolar(tabelas.sujeito),
    acao: null,
    amigo: rolar(tabelas.amigo),
    local: null,
    objeto: null,
    evento: rolar(tabelas.evento)
  };

  const acaoSorteada = rolar(tabelas.acao);
  r.acao = acaoSorteada === 'acao combinada*'
    ? rolarCombinado(tabelas.acao, 'acao combinada*')
    : acaoSorteada;

  const localSorteado = rolar(tabelas.local);
  r.local = localSorteado === 'local combinado*'
    ? rolarCombinado(tabelas.local, 'local combinado*')
    : localSorteado;

  const objetoSorteado = rolar(tabelas.objeto);
  r.objeto = objetoSorteado === 'objeto combinado*'
    ? rolarCombinado(tabelas.objeto, 'objeto combinado*')
    : objetoSorteado;

  document.getElementById('historia').innerHTML = `
    Um(a) <span class="highlight">${r.sujeito}</span>
    <span class="highlight">${r.acao}</span> em um(a)
    <span class="highlight">${r.local}</span>. Durante a investigação, o grupo terá a ajuda de um(a)
    <span class="highlight">${r.amigo}</span> e poderá encontrar 
    <span class="highlight">${r.objeto}</span>. Porém, em determinado momento, os agentes serão surpreendidos por
    <span class="highlight">${r.evento}</span>.
  `;

  gerarDetalhes(r);
}

/********************
 * DETALHES CONTEXTUAIS
 ********************/
function gerarDetalhes(r) {
  const detalhes = [];

  function paraCadaParte(valor, fn) {
    valor.split(' e ').forEach(v => fn(v.trim()));
  }

  if (r.sujeito.includes('criatura')) {
    detalhes.push(`A criatura é do elemento <strong>${rolar(['Sangue','Morte','Conhecimento','Energia'])}</strong>.`);
  }

  const criaturainv = [
    'invocou uma criatura de propósito',
    'invocou uma criatura sem querer'
  ];

  paraCadaParte(r.acao, parte => {
    if (criaturainv.some(l => parte.includes(l))) {
      detalhes.push(`A criatura invocada é do elemento <strong>${rolar(['Sangue','Morte','Conhecimento','Energia'])}</strong>.`);
    }
  });

  const locaisHabitados = [
    'escola','hospital','vilarejo','fazenda','arranha-céu','grande loja de departamento',
    'zona industrial da cidade','shopping center','orfanato','museu','mansão','navio'
  ];

  paraCadaParte(r.local, parte => {
    if (locaisHabitados.some(l => parte.includes(l))) {
      detalhes.push(`O local (${parte}) está <strong>${rolar(['abandonado','habitado'])}</strong>.`);
    }
  });

  if (r.amigo.includes('Ordo Realitas')) {
    detalhes.push(`O agente aliado está <strong>${rolar(['em atividade','aposentado'])}</strong>.`);
  }

  const objetosEquipamento = [
    'equipamento','equipamento modificado','item amaldiçoado'
  ];

  paraCadaParte(r.objeto, parte => {
    if (objetosEquipamento.some(o => parte.includes(o))) {
      detalhes.push(`O item (${parte}) é <strong>${rolar(['uma arma','uma proteção','um equipamento geral/acessório'])}</strong>.`);
    }
  });

  if (r.evento.includes('criatura')) {
    detalhes.push(`A criatura que aparece é do elemento <strong>${rolar(['Sangue','Morte','Conhecimento','Energia'])}</strong>.`);
  }

  document.getElementById('detalhesTexto').innerHTML = detalhes.length
    ? detalhes.join('<br><br>')
    : 'Nenhum detalhe adicional foi revelado nesta rolagem.';
}

/********************
 * EVENTO DO BOTÃO
 ********************/
document.getElementById('btnGerar').addEventListener('click', gerarHistoria);

/********************
 * SERVICE WORKER
 ********************/
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}
</script>

</body>
</html>
